from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import os
import base64
from openai import OpenAI

app = FastAPI()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


class AnalyzeRequest(BaseModel):
    username: str


class PhotoAnalyzeRequest(BaseModel):
    image_base64: str


@app.get("/")
def read_root():
    return {"message": "Instagram Analyzer API v2.0 - Photo Analysis Ready"}


@app.post("/analyze")
async def analyze_profile(request: AnalyzeRequest):
    """–ê–Ω–∞–ª–∏–∑ Instagram –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = request.username
    
    if not username:
        raise HTTPException(status_code=400, detail="Username is required")
    
    try:
        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ Instagram –ø—Ä–æ—Ñ–∏–ª–µ–π. –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è @{username}.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞:

üéØ –ü–†–û–§–ò–õ–¨ –ò –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï
‚Ä¢ –ö—Ç–æ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫/–±—Ä–µ–Ω–¥
‚Ä¢ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

üíé –ö–û–ù–¢–ï–ù–¢-–°–¢–†–ê–¢–ï–ì–ò–Ø
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
‚Ä¢ –°—Ç–∏–ª—å –ø–æ–¥–∞—á–∏
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π

üåç LIFESTYLE
‚Ä¢ –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
‚Ä¢ –ú–∞—Ä–∫–µ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
‚Ä¢ –¶–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã

üëó –°–¢–ò–õ–¨ –ò –≠–°–¢–ï–¢–ò–ö–ê
‚Ä¢ –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
‚Ä¢ –ú–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
‚Ä¢ –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞

üìä –ë–ò–ó–ù–ï–°-–ü–û–¢–ï–ù–¶–ò–ê–õ
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏

üîÆ –ò–¢–û–ì–û–í–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê
–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ: –∫—Ç–æ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ –∏ –∫–∞–∫–æ–≤–∞ –µ–≥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ Instagram.

–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –∏–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑."""

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π. –¢–≤–æ–∏ –∞–Ω–∞–ª–∏–∑—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=2000,
            temperature=0.7
        )
        
        analysis = response.choices[0].message.content
        return {"analysis": analysis}
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/analyze-photo")
async def analyze_photo(request: PhotoAnalyzeRequest):
    """–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä—ã, —Ä–µ—Ç—É—à—å –∏ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é"""
    
    if not request.image_base64:
        raise HTTPException(status_code=400, detail="Image is required")
    
    try:
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:image/...;base64, –µ—Å–ª–∏ –µ—Å—Ç—å
        image_data = request.image_base64
        if "base64," in image_data:
            image_data = image_data.split("base64,")[1]
        
        prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ —Ñ–æ—Ç–æ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:

üì∏ –ê–£–¢–ï–ù–¢–ò–ß–ù–û–°–¢–¨ –§–û–¢–û
–û—Ü–µ–Ω–∏ –ø–æ —à–∫–∞–ª–µ 0-100, –≥–¥–µ 100 = –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

üé≠ –î–ï–¢–ï–ö–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í –ò –û–ë–†–ê–ë–û–¢–ö–ò
–û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
‚Ä¢ Instagram/TikTok —Ñ–∏–ª—å—Ç—Ä—ã (–∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ, –µ—Å–ª–∏ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)
‚Ä¢ FaceApp (—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫–æ–∂–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä—Ç –ª–∏—Ü–∞)
‚Ä¢ Facetune/Photoshop (—Ä–µ—Ç—É—à—å, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–∏–≥—É—Ä—ã)
‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞/–∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
‚Ä¢ –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ (–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –±–æ–∫–µ)

ü§ñ AI-–ì–ï–ù–ï–†–ê–¶–ò–Ø
–û—Ü–µ–Ω–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ —Ñ–æ—Ç–æ —Å–æ–∑–¥–∞–Ω–æ AI (Midjourney, DALL-E, Stable Diffusion):
‚Ä¢ 0-20%: –¢–æ—á–Ω–æ —Ä–µ–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
‚Ä¢ 20-50%: –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–µ, –Ω–æ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è
‚Ä¢ 50-80%: –í–æ–∑–º–æ–∂–Ω–æ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚Ä¢ 80-100%: –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è

–£–∫–∞–∂–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Ç—ã —Å–¥–µ–ª–∞–ª –≤—ã–≤–æ–¥.

üë§ –ê–ù–ê–õ–ò–ó –í–ù–ï–®–ù–û–°–¢–ò (–µ—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ —á–µ–ª–æ–≤–µ–∫)
‚Ä¢ –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ
‚Ä¢ –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
‚Ä¢ –ü—Ä–∏–∑–Ω–∞–∫–∏ –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä (–µ—Å–ª–∏ –∑–∞–º–µ—Ç–Ω—ã)

üîç –î–ï–¢–ê–õ–ò –û–ë–†–ê–ë–û–¢–ö–ò
–û–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —á—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:
‚Ä¢ –ö–æ–∂–∞ (—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, –æ—Ç–±–µ–ª–∏–≤–∞–Ω–∏–µ)
‚Ä¢ –ß–µ—Ä—Ç—ã –ª–∏—Ü–∞ (–Ω–æ—Å, –≥—É–±—ã, –≥–ª–∞–∑–∞, –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫)
‚Ä¢ –§–∏–≥—É—Ä–∞ (–µ—Å–ª–∏ –≤–∏–¥–Ω–æ)
‚Ä¢ –§–æ–Ω
‚Ä¢ –û—Å–≤–µ—â–µ–Ω–∏–µ

üìä –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢
–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ: –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —á—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ."""

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system", 
                    "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫—Ä–∏–º–∏–Ω–∞–ª–∏—Å—Ç–∏–∫–µ –∏ –∞–Ω–∞–ª–∏–∑—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Ä–µ—Ç—É—à–∏, AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏."
                },
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}",
                                "detail": "high"
                            }
                        }
                    ]
                }
            ],
            max_tokens=2000,
            temperature=0.3
        )
        
        analysis = response.choices[0].message.content
        return {"analysis": analysis}
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
